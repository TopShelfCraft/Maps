
<h2>The Payment Form</h2>

<p>The payment form is the heart of Charge. There are a few required fields, and some optional ones too.</p>


<h3>Setup</h3>
<p>The payment form requires two hidden inputs - <em>action</em> and <em>redirect</em>.</p>

<dl>
	<dt><code>action</code></dt>
	<dd>The action to perform. For charge, this <strong>must</strong> have a value of '<strong>charge/charge</strong>'. This tells Craft to direct the post to Charge</dd>

	<dt><code>redirect</code></dt>
	<dd>The redirect url after a successful purchase. ie. <em>/payment/thanks</em>. On that url, the successful charge object will be available. You can also add any variable from the charge object to the path and it will be parsed out.</dd>
</dl>
<pre><code>&lt;form id="charge-form" method="post" action="" accept-charset="UTF-8"&gt;
    &lt;input type="hidden" name="<em>action</em>" value="<em>charge/charge</em>"&gt;
    &lt;input type="hidden" name="<em>redirect</em>" value="<em>payment/thanks/{hash}</em>"&gt;

    	..
    &lt;button type="submit"&gt;Pay&lt;/button&gt;
&lt;/form&gt;</code></pre>


<h3>Fields</h3>

<p>The basic form contains the following fields :</p>

<h5>Customer Fields</h5>
<dl>
	<dt><code>customerName</code> <em>*required</em></dt>
	<dd>The name for the customer</dd>

	<dt><code>customerEmail</code> <em>*required</em></dt>
	<dd>The email for the customer.</dd>
</dl>

<h5>Plan Fields</h5>

<dl>
	<dt><code>planAmount</code>  <em>*required</em></dt>
	<dd>The amount for the payment, in whole units. ie. 5 == $5 (assuming the currency is usd)</dd>

	<dt><code>planCurrency</code></dt>
	<dd>Optional. The currency for the payment. If not set, the default currency as set in the settings will be used. The possible currencies can also be affected by your Stripe account settings.</dd>

	<dt><code>planInterval</code></dt>
	<dd>The recurring interval. Value values are '' (blank), week, month or year. Only referenced if '<em>planIntervalCount</em>' is >= 1</dd>

	<dt><code>planIntervalCount</code></dt>
	<dd>The interval count to recur payments on. <em>0</em> implies a one-off charge. <em>1</em> implies a recurring payment every <em>planInterval</em> - ie. every week/month/year. Set to different values to recur with different counts. ie. every 3 months.</dd>

	<dt><code>planCoupon</code> <span class="note">New in 1.3</span></dt>
	<dd>An optional field to let your customers enter a coupon code. If supplied this code will be validated against all coupons on record. <a href="/addons/charge/docs/coupons">More about coupons</a>.</dd>
</dl>

<h5>Card Fields</h5>
<p class="note"><strong>Note:</strong> For these fields, we don't ever want to pass them to the server, so don't name the inputs. Instead, use a data attribute so Stripe.js can pick them up.</p>

<p>These fields need to be formatted slightly differently than normal fields. Like so : </p>

<pre><code>&lt;input type="text" <em>data-stripe="number"</em>/&gt;</code></pre>
<p>So - where you'd normally call the input '<em>name="cardNumber"</em>', give it an attribute of '<em>data-stripe="number"</em>' instead. The same for applies for all of the <strong>card*</strong> inputs</p>

<dl>
	<dt><code>cardNumber</code> <em>*required passed as</em> <code>data-stripe="number"</code></dt>
	<dd>The card number for the payment.</dd>

	<dt><code>cardCvc</code> <em>*required passed as</em> <code>data-stripe="cvc"</code></dt>
	<dd>The CVC for the card</dd>

	<dt><code>cardExpMonth</code> <em>*required passed as</em> <code>data-stripe="exp_month"</code></dt>
	<dd>The expiry month for the card</dd>

	<dt><code>cardExpYear</code> <em>*required passed as</em> <code>data-stripe="exp_year"</code></dt>
	<dd>The expiry year for the card</dd>

	<dt><code>cardName</code> <em>passed as</em> <code>data-stripe="name"</code></dt>
	<dt><code>cardAddressLine1</code> <em>passed as</em> <code>data-stripe="address_line1"</code></dt>
	<dt><code>cardAddressLine2</code> <em>passed as</em> <code>data-stripe="address_line1"</code></dt>
	<dt><code>cardAddressCity</code>  <em>passed as</em> <code>data-stripe="address_city"</code></dt>
	<dt><code>cardAddressState</code>  <em>passed as</em> <code>data-stripe="address_state"</code></dt>
	<dt><code>cardAddressZip</code>  <em>passed as</em> <code>data-stripe="address_zip"</code></dt>
	<dt><code>cardAddressCountry</code>  <em>passed as</em> <code>data-stripe="address_country"</code></dt>
	<dd><em>Optional</em> extra card name and address fields. Can be useful to reduce fraud detections</dd>
</dl>

<h5>Month &amp; Year Helpers</h5>

<p>For fields like <strong>cardExpMonth</strong> and <strong>cardExpYear</strong> you'll want to display a select input or years/months. Twig makes this easy :</p>

<pre><code>&lt;select data-stripe="exp_month"&gt;
	{% <em>for month in craft.i18n.getLocaleData().getMonthNames()</em> %}
  		&lt;option value="<em>{{ loop.index }}</em>" <em>{% if now.month == loop.index %}selected="selected"{% endif %}</em>&gt;<em>{{ month }}</em>&lt;/option&gt;
	{% <em>endfor</em> %}
&lt;/select&gt;</code></pre>

<p>and for years : </p>

<pre><code>&lt;select data-stripe="exp_year"&gt;
    {% <em>for year in now.year..now.year+5</em> %}
        &lt;option value="<em>{{ year }}</em>"&gt;<em>{{ year }}</em>&lt;/option&gt;
    {% <em>endfor</em> %}
&lt;/select&gt;</code></pre>


<h4>Form Re-population &amp; Error handling</h4>
<p>On submit validation is performed, and if an error is found, the page is reloaded with the charge object, with any errors attached. You can repopulate the form, and show any errors.</p>

<h5>Re-population</h5>
<p><strong>Standard fields</strong> can be directly repopulated like this : </p>

<pre><code>&lt;input type="text" name="customerName" value="<em>{% if charge is defined %}{{ charge.customerName }}{% endif %}</em>"&gt;</code></pre>

<p><strong>Card fields</strong> are handled differently. Charge never sees the direct card details, but instead gets a <em>cardToken</em>, <em>cardLast4</em> and <em>cardType</em> from Stripe. Re-population is done like this : </p>


<pre><code>{% if charge is defined and <em>charge.cardToken is not null</em> %}
    &lt;input type="hidden" name="<em>cardToken</em>" value="<em>{{ charge.cardToken }}</em>" <em>data-stripe="token"</em>/&gt;
    &lt;input type="hidden" name="<em>cardLast4</em>" value="<em>{{ charge.cardLast4 }}</em>"/&gt;
    &lt;input type="hidden" name="<em>cardType</em>" value="<em>{{ charge.cardType }}</em>"/&gt;

    Payment card : <em>{{ charge.formatCard() }}</em>
{% else %}
	<em>// Show the standard card fields</em>
{% endif %}</code></pre>

<p class="note"><strong>Note:</strong> Use <em>{{ charge.formatCard() }}</em> to show the formatted version of the card number, similar to : <em>&#183;&#183;&#183; &#183;&#183;&#183;&#183; &#183;&#183;&#183;&#183; 4242</em></p>



<h3>Errors</h3>

<p>If validation fails, the page will return with the charge object with the errors attached.</p>

<p>There are 'general' errors, along with field specific errors. You can define a twig macro to output the errors, like so : </p>

<pre><code>{% <em>macro errorList(errors)</em> %}
	{% if errors %}
        {% for error in errors %}
            <em>{{ error }}</em>
        {% endfor %}
	{% endif %}
{% <em>endmacro</em> %}</code></pre>

<p>Then display the errors like so : </p>

<pre><code>{% if charge is defined %}
    {{ _self.errorList(<em>charge.getErrors('general')</em>) }}
{% endif %}</code></pre>

<p>And also, per field errors like : </p>

<pre><code>{% if charge is defined %}
    {{ _self.errorList(<em>charge.getErrors('customerName')</em>) }}
{% endif %}</code></pre>

<p>Where 'customerName' can be any of the fields above.</p>

<p class="note"><strong>Note:</strong> Be sure to include the <strong>general</strong> error output in your form. If the payment fails on Stripe's side for any reason, that's where the error will be displayed</p>



<h4>Full Example</h4>
<p><a href="https://gist.github.com/joelbradbury/c2980902c2c24cf8d24c" class="button">View Complete Example Template &rarr;</a></p>
